name: 'Check and Close Invalid PR to Main'

on:
  pull_request_target:
    types:
      - opened
    branches:
      - main

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from upstream/dev
        id: check_source
        if: github.head_ref == 'dev' && !github.event.pull_request.head.repo.fork
        run: echo "is_valid=true" >> $GITHUB_OUTPUT

      - name: Allow valid PR
        if: steps.check_source.outputs.is_valid == 'true'
        run: echo "âœ… PR from upstream/dev to main is allowed. Continuing..."

      - name: Handle invalid PR
        if: steps.check_source.outputs.is_valid != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: prNumber,
              body: `
                ### âŒ ì˜ëª»ëœ Pull Request
                ì•ˆë…•í•˜ì„¸ìš”! **main** ë¸Œëœì¹˜ë¡œ ì§ì ‘ PRì„ ë³´ë‚´ëŠ” ê²ƒì€ ì •ì±…ìƒ ê¸ˆì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

                - **ê¸°ëŠ¥ ê°œë°œ, ë²„ê·¸ ìˆ˜ì • ë“±**ì˜ ì‘ì—…ì€ **dev** ë¸Œëœì¹˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ PRì„ ë³´ë‚´ì£¼ì„¸ìš”.
                - **main** ë¸Œëœì¹˜ëŠ” **dev** ë¸Œëœì¹˜ì˜ ë‚´ìš©ì´ ì¶©ë¶„íˆ ê²€ì¦ëœ í›„, ë¦´ë¦¬ìŠ¤ ë‹´ë‹¹ìì— ì˜í•´ì„œë§Œ ë³‘í•©ë©ë‹ˆë‹¤.

                ì´ PRì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤. ë¸Œëœì¹˜ ëŒ€ìƒì„ ë³€ê²½í•˜ì—¬ ë‹¤ì‹œ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜„
              `
            });

            await github.rest.pulls.update({
              owner: owner,
              repo: repo,
              pull_number: prNumber,
              state: 'closed'
            });

            core.setFailed("This PR was automatically closed because it targets the main branch incorrectly.");